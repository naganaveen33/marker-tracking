<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR.js Marker Tracking</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            z-index: 999;
            max-width: 300px;
            border-radius: 5px;
        }
        #instructions {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            font-family: Arial;
            font-size: 14px;
            z-index: 999;
            max-width: 350px;
            border-radius: 5px;
        }
        #startBtn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            padding: 20px 40px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="debug">
        Status: <span id="status">Initializing...</span><br>
        Marker: <span id="markerStatus">Not detected</span><br>
        Video: <span id="videoStatus">Not loaded</span><br>
        <button onclick="toggleDebug()" style="margin-top:10px; padding:5px;">Toggle AR Debug</button>
    </div>

    <div id="instructions">
        <b>Instructions:</b><br>
        1. Click "Start AR" button<br>
        2. Allow camera access<br>
        3. Point camera at your marker<br>
        4. Click on marker to play video<br>
        <small>Using Hiro marker for testing. <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png" target="_blank" style="color:#4CAF50">Download Hiro</a></small>
    </div>

    <button id="startBtn">Start AR Experience</button>

    <a-scene
        id="arScene"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
    >
        <a-assets timeout="10000">
            <video
                id="videoAsset"
                preload="auto"
                crossorigin="anonymous"
                playsinline
                webkit-playsinline
                muted
                loop
            ></video>
            <img
                id="thumbnailAsset"
                crossorigin="anonymous"
            />
        </a-assets>

        <!-- Using HIRO marker for testing - replace with custom marker once working -->
        <a-marker
            id="marker"
            preset="hiro"
            emitevents="true"
            smooth="true"
            smoothCount="5"
            smoothTolerance="0.01"
            smoothThreshold="2"
        >
            <a-video
                id="arVideo"
                src="#videoAsset"
                width="1.6"
                height="2.8"
                position="0 0 0"
                rotation="-90 0 0"
                visible="false"
            ></a-video>

            <a-image
                id="thumbnailImg"
                src="#thumbnailAsset"
                width="1.6"
                height="2.8"
                position="0 0 0"
                rotation="-90 0 0"
                visible="false"
            ></a-image>

            <!-- Fallback: Simple colored box for testing -->
            <a-box
                id="testBox"
                position="0 0.5 0"
                material="color: red;"
                scale="0.5 0.5 0.5"
            ></a-box>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        let arStarted = false;
        let markerVisible = false;
        let debugMode = false;

        const elements = {
            startBtn: document.getElementById('startBtn'),
            video: document.getElementById('videoAsset'),
            arVideo: document.getElementById('arVideo'),
            thumbnail: document.getElementById('thumbnailImg'),
            testBox: document.getElementById('testBox'),
            marker: document.getElementById('marker'),
            scene: document.getElementById('arScene'),
            status: document.getElementById('status'),
            markerStatus: document.getElementById('markerStatus'),
            videoStatus: document.getElementById('videoStatus')
        };

        // Asset URLs - update these to your GitHub raw URLs
        const ASSETS = {
            video: 'https://raw.githubusercontent.com/naganaveen33/marker-tracking/main/assets/videos/lv_0_20250111230939%20(1).mp4',
            thumbnail: 'https://raw.githubusercontent.com/naganaveen33/marker-tracking/main/assets/images/background.JPG'
        };

        function updateStatus(msg) {
            elements.status.textContent = msg;
            console.log('[AR] ' + msg);
        }

        function toggleDebug() {
            debugMode = !debugMode;
            elements.scene.setAttribute('arjs', `sourceType: webcam; debugUIEnabled: ${debugMode}; detectionMode: mono_and_matrix;`);
            updateStatus('Debug mode: ' + (debugMode ? 'ON' : 'OFF'));
        }

        // Load assets
        function loadAssets() {
            updateStatus('Loading assets...');
            
            // Load thumbnail
            elements.thumbnail.setAttribute('src', ASSETS.thumbnail);
            elements.thumbnail.addEventListener('loaded', () => {
                console.log('[AR] Thumbnail loaded');
            });
            
            // Load video
            elements.video.src = ASSETS.video;
            elements.video.addEventListener('loadeddata', () => {
                elements.videoStatus.textContent = 'Loaded';
                console.log('[AR] Video loaded successfully');
            });
            
            elements.video.addEventListener('error', (e) => {
                elements.videoStatus.textContent = 'Error loading';
                console.error('[AR] Video error:', e);
                updateStatus('Video failed to load - using box only');
            });
        }

        // Start AR button
        elements.startBtn.addEventListener('click', async () => {
            elements.startBtn.classList.add('hidden');
            arStarted = true;
            updateStatus('AR Started - Point at marker');
            loadAssets();
        });

        // Marker found
        elements.marker.addEventListener('markerFound', () => {
            markerVisible = true;
            elements.markerStatus.textContent = 'DETECTED âœ“';
            updateStatus('Marker found! Click to play video');
            
            // Show thumbnail or box
            if (elements.thumbnail.getAttribute('src')) {
                elements.thumbnail.setAttribute('visible', 'true');
                elements.testBox.setAttribute('visible', 'false');
            } else {
                elements.testBox.setAttribute('visible', 'true');
            }
        });

        // Marker lost
        elements.marker.addEventListener('markerLost', () => {
            markerVisible = false;
            elements.markerStatus.textContent = 'Lost';
            updateStatus('Marker lost');
            
            // Stop video and show thumbnail
            if (!elements.video.paused) {
                elements.video.pause();
                elements.arVideo.setAttribute('visible', 'false');
                elements.thumbnail.setAttribute('visible', 'true');
            }
            
            elements.testBox.setAttribute('visible', 'false');
        });

        // Click to play video
        document.addEventListener('click', () => {
            if (arStarted && markerVisible && elements.video.src) {
                // Hide thumbnail and box, show video
                elements.thumbnail.setAttribute('visible', 'false');
                elements.testBox.setAttribute('visible', 'false');
                elements.arVideo.setAttribute('visible', 'true');
                
                // Play video
                elements.video.play().then(() => {
                    updateStatus('Video playing');
                }).catch(err => {
                    console.error('[AR] Play error:', err);
                    updateStatus('Cannot play video');
                    // Show thumbnail again
                    elements.thumbnail.setAttribute('visible', 'true');
                    elements.arVideo.setAttribute('visible', 'false');
                });
            }
        });

        // Scene loaded
        elements.scene.addEventListener('loaded', () => {
            console.log('[AR] Scene loaded');
        });

        // Log initial info
        console.log('[AR] Using Hiro marker for testing');
        console.log('[AR] Download Hiro marker: https://raw.githubusercontent.com/AR-js-org/AR.js/master/data/images/hiro.png');
        console.log('[AR] Print the marker and point your camera at it');
    </script>
</body>
</html>
